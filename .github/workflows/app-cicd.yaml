name: Azodha CI-CD Pipeline

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build-test-scan-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: amoldevakate2026/azodha.run.place
      IMAGE_TAG: ${{ github.sha }}
      AWS_REGION: us-east-1
      CLUSTER_NAME: EKS_CLOUD
      NAMESPACE: azodha-dev
      DEPLOYMENT_NAME: project-azodha
      CONTAINER_NAME: project-azodha

    steps:
    # ------------------------------------------------
    # 1. Checkout Code
    # ------------------------------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ------------------------------------------------
    # 2. Set up Python & Run Tests
    # ------------------------------------------------
    - name: Run unit tests
      run: |
        pip install -r app/requirements.txt
        pytest app/

    # ------------------------------------------------
    # 3. SonarQube Scan
    # ------------------------------------------------
    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    # ------------------------------------------------
    # 4. Docker Login
    # ------------------------------------------------
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    # ------------------------------------------------
    # 5. Build Docker Image
    # ------------------------------------------------
    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .
        docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_NAME:latest

    # ------------------------------------------------
    # 6. Trivy Image Scan
    # ------------------------------------------------
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: table
        severity: CRITICAL,HIGH
        exit-code: 1


    # ------------------------------------------------
    # 7. Push Docker Image
    # ------------------------------------------------
    - name: Push Docker image
      run: |
        docker push $IMAGE_NAME:$IMAGE_TAG
        docker push $IMAGE_NAME:latest

    # ------------------------------------------------
    # 8. Configure AWS Credentials
    # ------------------------------------------------
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # ------------------------------------------------
    # 9. Deploy to EKS
    # ------------------------------------------------
    - name: Deploy to EKS
      run: |
        aws eks update-kubeconfig \
          --name $CLUSTER_NAME \
          --region $AWS_REGION

        sed -i "s/IMAGE_TAG/${IMAGE_TAG}/g" k8s/deployment.yaml

        kubectl apply -f k8s/pv.yaml -n $NAMESPACE
        kubectl apply -f k8s/service.yaml -n $NAMESPACE
        kubectl apply -f k8s/deployment.yaml -n $NAMESPACE

        kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE
